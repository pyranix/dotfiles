#!/bin/bash

DATA_DIR="$HOME/.pwgen"
DATA_FILE="$DATA_DIR/password_data.txt"

generate_password() {
    local length=$1
    local characters="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
    local password=$(tr -dc "$characters" < /dev/urandom | head -c "$length")
    echo "$password"
}

save_password() {
    local password=$1
    local note=$2
    local timestamp=$(date +"%Y-%m-%d %T")
    local salt=$(head -c 32 /dev/urandom | base64)
    local hashed_password=$(echo -n "$password$salt" | sha256sum | awk '{print $1}')
    
    # Create the directory if it doesn't exist
    mkdir -p "$DATA_DIR"

    # Append data to the specified file
    {
        echo "Timestamp: $timestamp"
        echo "Usage Note: $note"
        echo "Salt: $salt"
        echo "Hashed Password: $hashed_password"
        echo "------------------------------------"
    } >> "$DATA_FILE"

    echo "Password saved in $DATA_FILE with the note: $note"
}

copy_to_clipboard() {
    echo -n "$1" | xclip -selection clipboard
    echo "Password copied to clipboard"
}

main() {
    echo "Welcome to Password Generator"
    read -p "Please specify the length of the password: " length
    
    if ! [[ $length =~ ^[0-9]+$ ]]; then
        echo "Invalid input. Please enter a valid number."
        exit 1
    fi

    read -p "Please provide a note for what you're using this password for: " note
    
    password=$(generate_password "$length")
    
    save_password "$password" "$note"
    copy_to_clipboard "$password"
}

main
