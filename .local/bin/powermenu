#!/bin/bash

SCRIPT_NAME="powermenu"

# Power menu options
options=(" Poweroff" " Reboot" " Sleep" " Hibernate" " Log Out")

# Function to check the init system
detect_init_system() {
  if command -v systemctl &> /dev/null; then
    init_system="systemctl"
  elif command -v loginctl &> /dev/null; then
    init_system="loginctl"
  else
    notify-send -u low "Unable to detect init system. Exiting."
    exit 1
  fi
}

# Determine init system
detect_init_system

# Set commands based on init system
case $init_system in
  "systemctl")
    power_command="systemctl poweroff"
    reboot_command="systemctl reboot"
    sleep_command="systemctl suspend"
    hibernate_command="systemctl hibernate"
    logout_command="systemctl exit"
    ;;
  "loginctl")
    power_command="loginctl poweroff"
    reboot_command="loginctl reboot"
    sleep_command="loginctl suspend"
    hibernate_command="loginctl hibernate"
    logout_command="loginctl terminate-session"
    ;;
  *)
    notify-send -u low "Unsupported init system. Exiting."
    exit 1
    ;;
esac

# Function to confirm the action
confirm_option() {
  confirm=$(echo -e "Yes\nNo" | rofi -dmenu -i -p "Are you sure?" -columns 1 -width 10)
  [[ "$confirm" == "Yes" ]]
}

# Main script

selected_option=$(printf '%s\n' "${options[@]}" | rofi -dmenu -i -p "$SCRIPT_NAME" -columns 1 -width 20) || exit 1

case $selected_option in
    " Poweroff")
        if confirm_option; then
            notify-send -i "$HOME/.notify/images/power-button.png" "Powering off..."
            $power_command
        else
            notify-send -i "$HOME/.notify/images/multiply.png" "Power off canceled"
        fi
        ;;
    " Reboot")
        if confirm_option; then
            notify-send -i "$HOME/.notify/images/refresh.png" "Rebooting..."
            $reboot_command
        else
            notify-send -i "$HOME/.notify/images/multiply.png" "Reboot canceled"
        fi
        ;;
    " Sleep")
        if confirm_option; then
            notify-send -i "$HOME/.notify/images/sleep.png" "Putting system to sleep..."
            $sleep_command
        else
            notify-send -i "$HOME/.notify/images/multiply.png" "Sleep canceled"
        fi
        ;;
    " Hibernate")
        if confirm_option; then
            notify-send -i "$HOME/.notify/images/suspended.png" "Hibernating..."
            $hibernate_command
        else
            notify-send -i "$HOME/.notify/images/multiply.png" "Hibernation canceled"
        fi
        ;;
    " Log Out")
        if confirm_option; then
            notify-send -i "$HOME/.notify/images/arrow.png" "Logging out..."
            $logout_command
        else
            notify-send -i "$HOME/.notify/images/multiply.png" "Log out canceled"
        fi
        ;;
    *)
        notify-send -u low "Invalid option"
        ;;
esac

exit 0
