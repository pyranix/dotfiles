#!/bin/bash
set -e

# Define the theme and wallpaper folder paths
THEME_DIR="$HOME/.qtheme"
WALLPAPER_DIR="$HOME/.wallpaper"

# Function to select a theme
select_theme() {
    theme_list=$(ls "$THEME_DIR")
    selected_theme=$(rofi -dmenu -p "Select Theme:" <<< "$theme_list")

    if [ -n "$selected_theme" ]; then
        apply_theme "$selected_theme"
    else
        echo "No theme selected. Exiting..."
        exit 1
    fi
}

# Function to apply the selected theme
apply_theme() {
    local selected_theme="$1"
    SRC_PATH="$THEME_DIR/$selected_theme"
    DEST_PATH="$HOME/.config/"

    # Check if the theme directory exists
    if [ ! -d "$SRC_PATH" ]; then
        echo "Error: Theme directory '$SRC_PATH' not found."
        exit 1
    fi

    # Copy the selected theme to the destination
    cp -r "$SRC_PATH/"* "$DEST_PATH"

    # Update GTK settings based on the selected theme
    update_gtk_settings "$selected_theme"

    select_wallpaper
}

# Function to update GTK settings based on the selected theme
update_gtk_settings() {
    case $1 in
        "redrose")
            set_gtk_settings "adw-gtk3-red" "Tela-red"
            ;;
        "bluerod")
            set_gtk_settings "adw-gtk3-blue" "Tela-purple"
            ;;
        "nyoom")
            set_gtk_settings "adw-gtk3-dark" "Tela-black"
            ;;
        *)
            echo "Warning: Unknown theme. GTK settings not updated."
            ;;
    esac
}

# Function to set GTK settings
set_gtk_settings() {
    gsettings set org.gnome.desktop.interface gtk-theme "$1"
    gsettings set org.gnome.desktop.interface icon-theme "$2"
}

# Function to select a wallpaper
select_wallpaper() {
    wallpaper_list=$(ls "$wallpaper_dir")
    selected_wallpaper=$(echo "$wallpaper_list" | rofi -dmenu -p "Select Wallpaper:")

    if [ -n "$selected_wallpaper" ]; then
        # Set the selected wallpaper
        feh --bg-fill "$wallpaper_dir/$selected_wallpaper"
        echo "Wallpaper '$selected_wallpaper' set successfully!"
    else
        echo "No wallpaper selected. Using the default wallpaper."
    fi

    # Update user directories
    xdg-user-dirs-update
    xdg-user-dirs-gtk-update

    # Display user directories
    xdg-user-dir

    # Kill already running processes
    for process in xsettingsd firefox dunst thunar ksuperkey; do
        pidof "$process" && killall "$process"
    done

    # Restart Qtile to apply the changes
    qtile cmd-obj -o cmd -f restart
}

# Start the script by selecting a theme
select_theme
