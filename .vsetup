#!/usr/bin/env bash
# shellcheck disable=SC2199
# shellcheck disable=SC2086
# shellcheck source=/dev/null
#
# Copyright (C) 2024-02 pyranix <pyranix@proton.me>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Source environment variables
. "$HOME/.envvars"

# Init DIR
DIR="$HOME/.config"

# set
run() {
  if ! pgrep -f "$1" ; then
    "$@" &
  fi
}

# Main System
if [ -d /etc/X11/xinit/xinitrc.d ]; then
  for f in /etc/X11/xinit/xinitrc.d/?*.sh; do
    [ -x "$f" ] && . "$f"
  done
  unset f
fi

# Kill already running process
for _prs in xsettingsd dunst ksuperkey; do
    pid=$(pidof $_prs)
    [[ -n $pid ]] && kill -9 $pid
done

# polkit agent
if ! pidof xfce-polkit; then
    run /usr/lib/xfce-polkit/xfce-polkit &
fi

# Make dbus
if which dbus-launch >/dev/null && test -z "$DBUS_SESSION_BUS_ADDRESS"; then
  eval "$(dbus-launch --sh-syntax --exit-with-session)"
fi

# Load .profile
[ -f ~/.profile ] && . ~/.profile

# Run processes
run ~/.fehbg &
run pipewire &
run nm-applet &
run xfsettingsd &
run blueman-applet &
run powertop --auto-tune &
run xsetroot -cursor_name left_ptr &
run picom --config "$DIR/picom.conf" --daemon &
run xsettingsd --config="$DIR/xsettingsd/xsettingsd.conf"
